
var svgString ="<svg width=\"28\" height=\"28\" viewBox=\"0 0 64 64\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M32 64C14.3269 64 0 49.6731 0 32C0 14.3269 14.3269 0 32 0C49.6731 0 64 14.3269 64 32C64 49.6731 49.6731 64 32 64Z\" fill=\"#49F5D3\"/>\n<path d=\"M19.1 47.3H31.9343C32.4977 47.3 32.9543 46.8433 32.9543 46.28C32.9543 45.7167 32.4977 45.26 31.9343 45.26H19.1C18.5367 45.26 18.08 45.7167 18.08 46.28C18.08 46.8433 18.5367 47.3 19.1 47.3V47.3Z\" fill=\"#333333\"/>\n<path d=\"M19.1 41.18H31.34C31.9033 41.18 32.36 40.7233 32.36 40.16C32.36 39.5967 31.9033 39.14 31.34 39.14H19.1C18.5367 39.14 18.08 39.5967 18.08 40.16C18.08 40.7233 18.5367 41.18 19.1 41.18V41.18Z\" fill=\"#333333\"/>\n<path d=\"M34.9279 34.04C34.9279 33.4767 34.4713 33.02 33.9079 33.02H19.1C18.5367 33.02 18.08 33.4767 18.08 34.04C18.08 34.6033 18.5367 35.06 19.1 35.06H33.9079C34.4713 35.06 34.9279 34.6033 34.9279 34.04Z\" fill=\"#333333\"/>\n<path d=\"M41.54 26.9H19.1C18.5367 26.9 18.08 27.3567 18.08 27.92C18.08 28.4833 18.5367 28.94 19.1 28.94H41.54C42.1033 28.94 42.56 28.4833 42.56 27.92C42.56 27.3567 42.1033 26.9 41.54 26.9Z\" fill=\"#333333\"/>\n<path d=\"M41.54 20.78H19.1C18.5367 20.78 18.08 21.2367 18.08 21.8C18.08 22.3633 18.5367 22.82 19.1 22.82H41.54C42.1033 22.82 42.56 22.3633 42.56 21.8C42.56 21.2367 42.1033 20.78 41.54 20.78Z\" fill=\"#333333\"/>\n<path d=\"M44.26 12.62H40.52V11.6C40.52 11.0367 40.0633 10.58 39.5 10.58C38.9367 10.58 38.48 11.0367 38.48 11.6V12.62H34.4V11.6C34.4 11.0367 33.9433 10.58 33.38 10.58C32.8167 10.58 32.36 11.0367 32.36 11.6V12.62H28.28V11.6C28.28 11.0367 27.8233 10.58 27.26 10.58C26.6967 10.58 26.24 11.0367 26.24 11.6V12.62H22.16V11.6C22.16 11.0367 21.7033 10.58 21.14 10.58C20.5767 10.58 20.12 11.0367 20.12 11.6V12.62H16.38C15.0662 12.6216 14.0016 13.6862 14 15V51.04C14.0016 52.3538 15.0662 53.4184 16.38 53.42H35.6451C36.2084 53.42 36.6651 52.9633 36.6651 52.4C36.6651 51.8367 36.2084 51.38 35.6451 51.38H16.38C16.1923 51.3798 16.0402 51.2277 16.04 51.04V15C16.0402 14.8123 16.1923 14.6602 16.38 14.66H20.12V15.68C20.12 16.2433 20.5767 16.7 21.14 16.7C21.7033 16.7 22.16 16.2433 22.16 15.68V14.66H26.24V15.68C26.24 16.2433 26.6967 16.7 27.26 16.7C27.8233 16.7 28.28 16.2433 28.28 15.68V14.66H32.36V15.68C32.36 16.2433 32.8167 16.7 33.38 16.7C33.9433 16.7 34.4 16.2433 34.4 15.68V14.66H38.48V15.68C38.48 16.2433 38.9367 16.7 39.5 16.7C40.0633 16.7 40.52 16.2433 40.52 15.68V14.66H44.26C44.4477 14.6602 44.5998 14.8123 44.6 15V27.92C44.6 28.4833 45.0567 28.94 45.62 28.94C46.1833 28.94 46.64 28.4833 46.64 27.92V15C46.6384 13.6862 45.5738 12.6216 44.26 12.62V12.62Z\" fill=\"#333333\"/>\n<path d=\"M45.62 30.98C39.4234 30.98 34.4 36.0034 34.4 42.2C34.4 48.3966 39.4234 53.42 45.62 53.42C51.8166 53.42 56.84 48.3966 56.84 42.2C56.8329 36.0063 51.8137 30.9871 45.62 30.98V30.98ZM51.228 40.2689L44.5641 46.9334C44.3573 47.1403 44.0716 47.2484 43.7796 47.2303C43.4876 47.2121 43.2174 47.0694 43.0378 46.8385L39.928 42.8395C39.5821 42.3948 39.6623 41.754 40.107 41.4081C40.5516 41.0623 41.1925 41.1424 41.5383 41.5871L43.9389 44.6736L49.7857 38.8266C50.184 38.4283 50.8297 38.4283 51.228 38.8266C51.6263 39.2249 51.6263 39.8706 51.228 40.2689L51.228 40.2689Z\" fill=\"#3498DB\"/>\n</svg>\n";





$('#movie_player > div.ytp-chrome-bottom > div.ytp-chrome-controls > div.ytp-right-controls')
.append(`

    <button class="ytp-button CSN-btn" id="CSN-btn" title="Campers Smart Notes" data-tooltip-target-id="Campers Smart Notes">
        <div>    
            ${svgString.trim()}
        </div>
    </button>

`);




$("button#CSN-btn").bind('click', async function (e) {
    
    var videoId = window.location.href.split("=")[1];

    var currentTime = document.getElementsByClassName("video-stream")[0].currentTime;
    currentTime = Math.floor(currentTime);

    
    
    $('body > *').remove();


    $('head')
    .append(`
        <style>
            html, body {
                padding: 0;
                margin: 0;
                border: 0;
                box-sizing: border-box;
            }

            html {}
            body {
                display: flex;              
                justify-content: center;
            }

        </style>
    `);


    
    var editorUrl = chrome.runtime.getURL("contents/editor/editor.html");
    var editorJSUrl = chrome.runtime.getURL("contents/editor/editor.js");
    var editorCSSUrl = chrome.runtime.getURL("contents/editor/editor.css");


    $('body')
    .append(`
        <div id="MainFrame">
            <iframe src="https://www.youtube.com/embed/${videoId}?start=${currentTime}&autoplay=1&showinfo=0&rel=0&fs=0&autohide=0" name="videoFrame" title="videoFrame" class="videoFrame" id="videoFrame"></iframe>
        

        </div>
    `);




            // <iframe src="${editorUrl}" name="editorFrame" title="editorFrame" class="editorFrame" id="editorFrame"></iframe>



    // console.log( editorUrl );
    // console.log($('div#MainFrame iframe#editorFrame').contents().find('html body > *'));



    

    await $.get( editorUrl , async (htmlString) => {

        $('div#MainFrame').append(`
            <iframe name="editorFrame" title="editorFrame" class="editorFrame" id="editorFrame"></iframe>
        `);



        var editDoc = new DOMParser().parseFromString(htmlString, "text/html");

        $('div#MainFrame iframe#editorFrame').contents().find('html head').html($(editDoc.querySelector('head')).html());
        $('div#MainFrame iframe#editorFrame').contents().find('html body').html($(editDoc.querySelector('body')).html());
        


    });


    await $.get( editorCSSUrl, (cssString) => {

        $('div#MainFrame iframe#editorFrame').contents().find('html head')
        .append(`
            <style>${cssString}</style>
        `);
    });






    // JS for editor
    await JS();








});




function JS() {


    var editorDoc = $('div#MainFrame iframe#editorFrame').contents()[0];        
    var richTextField = editorDoc.querySelectorAll('html body iframe#richTextField')[0].contentWindow;
    
    richTextField.document.designMode = 'On';
    


    for (const elem of editorDoc.querySelectorAll('button.click-cmd')) {   

        $(elem).bind('click', function (e) {       
            richTextField.document.execCommand( $(this).attr('clickCmd') , false, null);
        });
    
    }



    for (const elem of editorDoc.querySelectorAll('button.click-cmd-arg')) {   


        $(elem).bind('click', function (e) {       
            
            
            if ($(this).attr('cmd-arg').split('prompt')) {
                
                var promptString = prompt( $(this).attr('cmd-arg').split('prompt')[1].split(',')[0].split("'")[1], '');
                if (promptString  != null ) 
                    richTextField.document.execCommand( $(this).attr('clickCmdArg') , false, promptString);
            }
            // richTextField.document.execCommand( $(this).attr('clickCmdArg') , false, $(this).attr('cmd-arg'));
        });
    
    }
    
    
    for (const elem of editorDoc.querySelectorAll('.change-cmd')) {
        $(elem).bind('change', function (e) {        
            richTextField.document.execCommand( $(elem).attr('changeCmd') , false, $(elem).val() );
        });
    }
    


    $(richTextField.document.querySelector('head'))
    .append(`            
    <style>
            img {
                width: 400px;
                height: auto;
            }
        </style>
    `);
    
    
    $(editorDoc.querySelector('button#pic')).bind('click', (e) => {


        var player = $('iframe#videoFrame').contents()[0].querySelector('video.video-stream');
        
        var ht = parseInt(player.style.height.split('px')[0]);
        var wd = parseInt(player.style.width.split('px')[0]);
    
        var canvas = document.createElement("canvas");
        canvas.height = ht;
        canvas.width = wd;
        canvas.getContext('2d').drawImage(player, 0, 0, wd, ht);
      
        var base64Canvas = canvas.toDataURL("image/jpeg");
    
        richTextField.document.execCommand('insertImage', false, base64Canvas);

        var currImg = richTextField.document.querySelectorAll('img');
        currImg = currImg[currImg.length-1];

        
        $(currImg).attr('id', player.currentTime);   
        
        $( currImg ).bind('dblclick', function (e) {

            this.style.width = prompt("Width: ", (''+this.style.width.split('px')[0]));
            this.style.height = 'auto';
        });



    });



    $(editorDoc.querySelector('button#inspic')).bind('click', (e) => {


        var inptFile = document.createElement('input');
        inptFile.type = "file";
        inptFile.name = "file";
        inptFile.id   = "file";
        inptFile.accept = "image/*";


        $(inptFile).click();


        $(inptFile).bind('change', (e) => {
                        
            console.log("--------->");

            var uploadedImgUrl = URL.createObjectURL(e.target.files[0]);


            

            const reader = new FileReader();
            reader.onload = (e) => { 

                // console.log( e.target.result );


                var picUrl = e.target.result;

                if (typeof(picUrl) != "undefined" && picUrl.length != 0) {

                    richTextField.document.execCommand('insertImage', false, picUrl);
        
        
        
                    var currImg = richTextField.document.querySelectorAll('img');        
                    currImg = currImg[currImg.length-1];
        
        
                    
                    $( currImg ).bind('dblclick', function (e) {
        
                        this.style.width = prompt("Width: ", (''+this.style.width.split('px')[0]));
                        this.style.height = 'auto';
                    });
        
                }

            };



            reader.readAsDataURL(e.target.files[0]);

        });

        





        
        // var picUrl = prompt("Enter the Pic URL", "");

        // if (picUrl != null && picUrl.length != 0) {

        //     richTextField.document.execCommand('insertImage', false, picUrl);



        //     var currImg = richTextField.document.querySelectorAll('img');        
        //     currImg = currImg[currImg.length-1];


            
        //     $( currImg ).bind('dblclick', function (e) {

        //         this.style.width = prompt("Width: ", (''+this.style.width.split('px')[0]));
        //         this.style.height = 'auto';
        //     });

        // }
    });





    
    $(editorDoc.querySelector('button#pdf')).bind('click', (e) => {

        richTextField.focus();
        richTextField.print();
    });

    
    
    




}





